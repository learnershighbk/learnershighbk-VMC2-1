# 예약 조회 페이지 유스케이스

## Primary Actor
- 기존 예약 내역을 확인하거나 취소하려는 사용자

## Precondition
- 사용자는 예약 시 사용한 전화번호와 4자리 비밀번호를 기억하고 있다.
- 사용자는 예약 조회 페이지에 접근할 수 있다.

## Trigger
- 사용자가 예약 조회 페이지에 진입하고 전화번호/비밀번호를 입력한다.

## Main Scenario
1. FE는 입력 폼을 렌더링하고 실시간으로 형식을 검증한다.
2. 사용자가 전화번호와 비밀번호를 입력 후 `조회하기`를 클릭한다.
3. FE는 검증된 입력값을 해시 또는 안전한 형식으로 BE에 전송한다.
4. BE는 전화번호/비밀번호 조합을 검증하고 `reservations` 테이블에서 해당 사용자의 예약 목록을 조회한다.
5. Database는 조건에 맞는 예약 목록을 반환한다.
6. BE는 최신순으로 정렬된 예약 리스트를 FE에 반환한다.
7. FE는 결과 목록을 표시하고 각 예약의 상세 정보를 확장할 수 있게 한다.
8. 사용자가 특정 예약에서 `예약 취소`를 선택하면 FE는 확인 모달을 표시한다.
9. 사용자가 취소를 확정하면 FE는 취소 요청을 BE에 전송한다.
10. BE는 트랜잭션으로 예약 상태를 확인하고 좌석/재고를 복구한 후 예약 상태를 `canceled`로 갱신한다.
11. Database는 좌석 상태와 예약 레코드를 업데이트하고 결과를 반환한다.
12. BE는 성공 응답을 FE에 전달하고, FE는 목록을 재조회해 최신 상태를 반영한다.

## Edge Cases
- 인증 실패: BE는 401/403을 반환하고 FE는 오류 메시지와 재입력을 안내한다.
- 예약 없음: FE는 `예약 내역이 없습니다` 빈 상태를 표시한다.
- 이미 취소된 예약: BE는 idempotent한 결과를 반환하고 FE는 상태를 유지한다.
- 공연 시작 임박/경과로 취소 불가: BE는 제한 사유를 포함한 오류 코드를 반환하고 FE는 안내 메시지를 표시한다.
- 네트워크 오류: FE는 재시도 버튼을 제공하며 마지막 성공 조회 결과를 임시 보관하지 않는다.
- 동시 취소 요청: BE는 트랜잭션으로 하나만 성공시키고 실패 시 최신 상태로 재조회하도록 한다.

## Business Rules
- 전화번호와 비밀번호는 클라이언트에서 즉시 마스킹하며 서버에는 해시 또는 토큰화하여 전달한다.
- 예약 조회 결과는 기본적으로 예약 상태가 `reserved`인 항목을 우선 표시하고 과거 항목은 축약한다.
- 취소 가능 기간은 공연 시작 전 정책으로 제한하며, 이를 초과한 경우 취소 버튼을 비활성화한다.
- 취소 성공 시 좌석 재고 및 좌석 상태가 즉시 복구되어야 한다.
- 재조회 시마다 최신 데이터를 서버에서 가져와 리프레시한다.

```
@startuml
actor User
participant FE
participant BE
database Database

User -> FE: 예약 조회 페이지 진입
FE -> User: 전화번호/비밀번호 입력 요청
User -> FE: 조회하기 클릭
FE -> BE: POST /reservations/search {phone, password}
BE -> Database: reservations 조회
Database --> BE: 예약 목록
BE --> FE: 200 OK + 예약 목록
FE -> User: 예약 목록 표시
User -> FE: 예약 취소 선택
FE -> BE: POST /reservations/{id}/cancel
BE -> Database: 좌석/재고 복구 트랜잭션
Database --> BE: 취소 결과
BE --> FE: 200 OK
FE -> User: 최신 상태로 갱신
@enduml
```



# 1. 홈 (Home)

## 입력

* 목록 스크롤/페이지네이션
* 콘서트 카드 클릭
* 정렬/필터(일자, 장소, 판매상태 등) 선택
* 새로고침, 뒤로가기/앞으로가기
* 네트워크 단절 상태에서의 재시도

## 처리

1. 초기 로드: 캐시(있다면) → Supabase `concerts` 목록 조회(필요 시 페이지네이션·정렬·필터 적용).
2. 썸네일/메타 최소 데이터 우선 렌더 → 잔여좌석 요약이 필요하면 `seat_classes` 집계 쿼리(선택).
3. 사용자의 정렬/필터 선택 시, 쿼리 파라미터 동기화 및 데이터 재조회.
4. 카드 클릭 시 라우팅: 선택 콘서트 `id`를 포함한 상세 페이지로 이동.
5. 오류/타임아웃 시 재시도 정책 적용(지수 백오프/최대 횟수).
6. 접근성: 키보드 포커스 이동/포커스 트랩 방지.

### 엣지케이스 처리

* 목록 0건: 빈 상태(UI 뼈대)만 노출.
* 일부 레코드 누락/비정상 데이터: 해당 카드만 스켈레톤/비표시.
* 중복 클릭·다중 라우트 트리거: 더블클릭 디바운스.
* 오프라인: 캐시 표시 + 온라인 전환 시 재동기화.

## 출력

* 콘서트 카드 리스트(포스터/제목/일시/장소).
* 로딩/스켈레톤, 오류 알림(재시도 버튼 포함).
* 상세 페이지로의 이동 완료.

---

# 2. 콘서트 상세 (Concert Detail)

## 입력

* 페이지 진입 시 자동 조회
* “예약하기” 버튼 클릭
* 상단/하단 이동
* 새로고침, 뒤로가기

## 처리

1. `concerts`에서 기본정보 조회.
2. `seat_classes`에서 등급별 가격·총좌석·잔여좌석 조회(트랜잭션 일관성 고려: 읽기전용).
3. 페이지 뷰 로깅(선택).
4. “예약하기” 클릭 시, 선택한 콘서트 `id` 전달하며 좌석 선택 페이지로 라우팅.
5. 데이터 갱신 텀 내 일시적 불일치 대비: 좌석 선택 페이지에서 재확인.

### 엣지케이스 처리

* 공연이 비활성/판매 중지: 예약 버튼 비활성.
* 등급 정보 불일치/누락: 해당 등급 섹션 비표시 및 로그.
* 재고 표시가 지연: 스켈레톤/지연 로딩 표시.
* 과거 날짜 공연: 예약 버튼 숨김/비활성.

## 출력

* 공연 기본정보 및 상세설명 표시.
* 등급별 잔여좌석 요약 표.
* 예약 플로우로 이동 가능 상태.

---

# 3. 좌석 선택 (Seat Selection)

## 입력

* 등급 탭/필터 선택
* 좌석도에서 좌석 클릭/해제(다중 선택)
* 선택 좌석 초기화
* 전화번호 입력
* 4자리 숫자 비밀번호 입력
* “예약하기” 버튼 클릭
* 뒤로가기/새로고침/멀티탭 동시 조작

## 처리

1. 진입 시 데이터 동기화:

   * `seat_classes` 재조회(가격/잔여 확인).
   * `seats`에서 현재 예약상태(`is_reserved`) 조회(좌석도 구성).
2. 좌석 선택 UX:

   * 좌석 클릭 시 클라이언트 상태에 추가.
   * 선택 수량 제한(최대치 정책) 검증.
   * 동일 좌석 중복 선택 방지.
3. 리얼타임 경쟁 방지(낙관적 UI 금지, 확정 전 잠금/검증):

   * **옵션 A: 임시홀드(소프트 락) 테이블/컬럼 사용**

     * 좌석 선택 시 `seat_holds`에 (seat_id, concert_id, client_session_id, expires_at) 등록(짧은 TTL).
     * 동일 좌석의 유효 홀드 존재 시 선택 불가.
     * 페이지 이탈/만료 시 자동 해제(백그라운드 정리 잡).
   * **옵션 B: 예약 확정 시점 원자적 예약만**

     * 선택은 로컬 상태 유지, **예약 시 트랜잭션**에서 최종 검증/실패 시 롤백.
4. 총액 계산: (좌석 단가 × 수량) 실시간 표시.
5. 입력 검증:

   * 전화번호 형식/길이, 숫자 여부.
   * 비밀번호 숫자 4자리, 연속·반복 제한(선택).
6. **예약 실행(핵심 트랜잭션)**:

   * 단일 트랜잭션으로 아래 작업 원자화:
     a) 선택 좌석들이 **아직 예약되지 않았는지** `seats.is_reserved = false` 검증(+ 필요한 경우 `seat_holds` 소유권 검증).
     b) `seats.is_reserved = true`로 업데이트(선택 좌석만).
     c) `seat_classes.available_seats`에서 등급별 수량 차감(음수 방지, 체크 제약).
     d) `reservations`에 (concert_id, phone_hash(or phone), password_hash, seats(JSON), total_price, status='reserved') 삽입.
   * 어떤 단계라도 실패 시 전부 롤백.
7. 성공 시 예약 식별자 획득.
8. 성공 후 임시홀드 사용 시 관련 홀드 해제/정리.

### 엣지케이스 처리

* **경쟁 충돌**: 누군가 먼저 같은 좌석 예약 → 트랜잭션 실패 → 선택 좌석 중 충돌 좌석만 제거하고 최신 상태 재조회.
* **재고 부족**: `available_seats` 음수 방지 제약 위반 → 실패 후 재계산/재표시.
* **입력 오류**: 전화번호/비밀번호 규칙 불만족 → 제출 차단.
* **다중 제출**: 버튼 연타 방지(로딩 상태·중복요청 차단 토큰).
* **세션 만료/홀드 만료**: 만료 시 좌석 선택 초기화 및 재조회.
* **오프라인/타임아웃**: 로컬 상태 유지 + 재시도 옵션 제공.
* **멀티탭**: 동일 계정/세션의 좌석 충돌 감지(클라이언트 세션키 비교).

## 출력

* 좌석도(빈/선택/매진 상태) 실시간 반영.
* 선택 좌석 목록, 수량, 총액.
* 검증 실패 시 원인 유형별 안내(카피 없음) 및 복구 동작(해당 좌석 해제/재조회/재시도).
* 성공 시 **예약 완료 페이지**로 라우팅(예약 식별자 전달).

---

# 4. 예약 완료 (Reservation Success)

## 입력

* 페이지 진입(예약 식별자 포함)
* 복사/공유 인터랙션(선택)
* 홈/조회 페이지로 이동

## 처리

1. 전달된 식별자로 `reservations` 조회(상태=`reserved` 확인).
2. `concerts`, `seat_classes` 조인 없이도 표시 가능하도록 `reservations.seats` JSON·`total_price` 활용. 필요 시 공연명/일시를 `concerts`에서 보강 조회.
3. SSR/CSR 환경에서 잘못된 접근(직접 URL/만료) 처리.

### 엣지케이스 처리

* 식별자 불일치/만료/취소됨: 안전한 리디렉션 또는 빈 상태 처리.
* 새로고침: 동일 정보 재표시(중복 생성 금지).
* 다른 브라우저에서 접근: 조회 가능 범위 내 표시(민감정보 최소화).

## 출력

* 예약 요약(공연명/일시, 등급/열/행/좌석수, 총액, 예약 식별 정보).
* 다음 행동(홈/예약 조회로 이동 가능).

---

# 5. 예약 조회 (Reservation Lookup)

## 입력

* 전화번호 입력
* 4자리 비밀번호 입력
* “조회하기” 버튼 클릭
* 결과 리스트에서 특정 예약 선택
* “예약 취소” 버튼 클릭
* 취소 확인(모달/확정 인터랙션)

## 처리

1. 입력 검증(형식/숫자/길이).
2. 전화번호·비밀번호 조합으로 `reservations` 조회(해시 비교).

   * 결과가 다수인 경우 최신순/상태 필터(예: `reserved` 우선).
3. 결과 리스트/상세 표시.
4. **취소 프로세스(트랜잭션)**:

   * 상태·공연 시간 검증(취소 가능 기간 제한이 있다면 확인).
   * `reservations.status`가 `reserved`인지 확인.
   * `seats`에서 해당 예약 좌석들을 `is_reserved=false`로 일괄 업데이트.
   * `seat_classes.available_seats` 등급별 수량 복구.
   * `reservations.status='canceled'`, 취소일시 기록.
   * 중간 단계 실패 시 롤백.
5. 리얼타임 반영: 동일 콘서트 좌석도/등급 재고(다른 세션에서) 갱신될 수 있도록 채널 브로드캐스트(선택).

### 엣지케이스 처리

* 인증 실패(전화번호/비밀번호 불일치): 제출 차단 및 재입력 유도.
* 예약 없음/이미 취소됨/공연 경과: 취소 버튼 비활성 또는 취소 불가 처리.
* 동시 취소/경쟁: 상태 변화 감지 시 재조회 후 결과만 표시.
* 다중 제출: 취소 요청 중복 방지.
* 오프라인/타임아웃: 재시도 제공.

## 출력

* 조회 결과 목록/상세(공연명/일정/좌석정보/금액/상태/예약일자).
* 취소 완료 시 상태가 `canceled`로 변경됨과 재고 복구 반영.
* 오류/불가 사유 알림(카피 없음).

---

# 정적 페이지 (이용약관 / 개인정보처리방침)

## 입력

* 페이지 진입/스크롤/외부 링크 클릭

## 처리

* 정적 콘텐츠 렌더링(빌드타임/런타임).
* 외부 링크 보안 속성 적용.

### 엣지케이스 처리

* 문서 불러오기 실패: 로딩/재시도 제공.

## 출력

* 문서 본문 표시 및 탐색 가능.

---

# 공통(전역) 플로우 & 가드

## 입력

* 모든 페이지에서의 새로고침/뒤로가기/오프라인 전환
* 키보드/스크린리더 사용
* 다국어/통화 포맷(선택)

## 처리

1. **상태 관리**: 선택 좌석/입력값은 일시 저장(메모리/세션스토리지)하되, 보안정보(비밀번호)는 메모리 한정.
2. **포맷팅**: 금액·일시 표시 로케일 적용(카피 제외).
3. **에러 핸들링 표준화**: 네트워크/권한/검증/경쟁 충돌/서버 오류 분류 후 대응 컴포넌트 재사용.
4. **보안**:

   * 전화번호 최소 수집, 비밀번호 해시 처리(클라이언트→서버 구간 암호화).
   * 예약 식별 정보 노출 최소화.
   * 봇/남용 방지(속도 제한/간단 검증).
5. **접근성**: 포커스 이동/라이브 영역 알림/대체 텍스트.
6. **성능**: 이미지 지연 로딩, 쿼리 캐시, 점진적 로딩.
7. **동시성**: 실시간 채널/폴링 중 택1로 재고 동기화.

### 엣지케이스 처리

* 다중 탭 사이 충돌: 최신 상태 기준으로 UI 재조정.
* 브라우저 비정상 종료: 홀드 자동 만료로 좌석 복구.
* 시간 동기화 문제(클라이언트/서버 시간차): 서버 시간 기준 검증.

## 출력

* 일관된 로딩/오류/빈 상태 표시.
* 반응형 레이아웃 유지.
* 사용자 작업 보존(가능한 범위 내).

---

# 데이터 무결성 & 트랜잭션 요약

## 예약(확정) 트랜잭션

* 입력: concert_id, seats[], phone, password(해시 전송 또는 서버 해시), expected_total
* 처리(원자적):

  1. 좌석 상태 검증(`is_reserved=false`)
  2. 좌석 상태 업데이트(true)
  3. 등급별 재고 차감(체크 제약)
  4. 예약 레코드 생성(status='reserved', seats JSON, total)
* 출력: 예약 식별자, 성공 여부/실패 사유

## 취소 트랜잭션

* 입력: reservation_id, phone, password
* 처리(원자적):

  1. 상태/시간 검증
  2. 좌석 상태 복구(false)
  3. 등급별 재고 복구(+n)
  4. 예약 상태 업데이트('canceled')
* 출력: 취소 완료 여부/실패 사유

---

# QA 체크리스트(요약)

* 경쟁 예약 시 실패 후 UI가 즉시 최신 상태로 복구되는가
* 선택 좌석 수량 제한/등급 혼합 시 합산 금액 정확한가
* 전화번호/비밀번호 유효성 및 저장 범위가 안전한가
* 오프라인/재시도/타임아웃 시 사용자 진행 흐름이 유지되는가
* 멀티탭/새로고침 시 이중 예약이 방지되는가
* 취소 후 재고·좌석도가 즉시 반영되는가
* 과거 공연/판매중지 공연은 예약 유도 동작이 차단되는가

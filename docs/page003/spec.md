# 좌석 선택 페이지 유스케이스

## Primary Actor
- 공연 좌석을 직접 선택해 예약을 진행하려는 사용자

## Precondition
- 사용자는 콘서트 상세 페이지에서 `예약하기`를 통해 좌석 선택 페이지에 도달했다.
- 사용자는 전화번호와 4자리 비밀번호를 준비했다.

## Trigger
- 사용자가 좌석 선택 페이지에 접근한다.

## Main Scenario
1. FE는 콘서트 ID를 기반으로 좌석 등급과 좌석 상태를 로딩하면서 기본 UI를 렌더링한다.
2. FE는 BE에 좌석 등급(`seat_classes`)과 좌석 상태(`seats`)를 조회한다.
3. BE는 공연 판매 상태, 요청 유효성, 선택 제한 규칙을 검증한다.
4. Database는 등급 정보와 좌석별 예약 상태를 반환한다.
5. FE는 좌석도 및 잔여 좌석 정보를 표시하고, 사용자의 좌석 선택을 로컬 상태로 관리한다.
6. 사용자가 좌석을 선택하면 FE는 선택 수량 제한 및 중복을 체크하고 주문 요약을 갱신한다.
7. 사용자가 전화번호와 비밀번호를 입력하고 `예약하기`를 클릭하면 FE는 예약 요청을 BE로 전송한다.
8. BE는 트랜잭션으로 좌석 예약 가능 여부를 검증하고, 성공 시 예약을 생성하며 좌석/재고 상태를 갱신한다.
9. BE는 예약 식별자와 함께 성공 응답을 반환하고, FE는 예약 완료 페이지로 이동시킨다.

## Edge Cases
- 동시 예약 충돌: BE 트랜잭션이 실패하면 충돌 좌석만 해제 후 최신 상태를 재조회하도록 에러 코드와 메시지를 제공한다.
- 입력 검증 실패: FE는 전화번호/비밀번호 규칙을 즉시 검증해 제출을 막고, BE는 422 응답으로 재확인한다.
- 좌석 선택 제한 초과: FE는 안내 토스트를 띄우고 이전 선택 상태를 유지한다.
- 네트워크 오류: FE는 재시도 버튼과 로컬 선택 상태 유지를 제공한다.
- 세션 이탈/만료: FE는 페이지 이탈 시 선택 상태를 초기화하고, BE는 임시 홀드가 있다면 만료 처리한다.

## Business Rules
- 한 번에 예약 가능한 좌석 수는 정책에서 정의한 최대값을 초과할 수 없다.
- 전화번호는 숫자만 허용하며, 비밀번호는 숫자 4자리로 제한된다.
- 동일 좌석에 대해 중복 선택 또는 중복 예약은 허용되지 않는다.
- 예약 총액은 서버가 계산하는 값을 기준으로 하며 클라이언트 합계와 불일치 시 서버 값을 우선한다.
- 예약 생성 후에는 같은 세션에서 중복 제출을 허용하지 않는다.

```
@startuml
actor User
participant FE
participant BE
database Database

User -> FE: 좌석 선택 페이지 진입
FE -> BE: GET /concerts/{id}/seats
BE -> Database: seat_classes, seats 조회
Database --> BE: 좌석 등급 + 상태 데이터
BE --> FE: 200 OK + 좌석 데이터
FE -> User: 좌석도 및 잔여 좌석 표시
User -> FE: 좌석 선택/입력
User -> FE: 예약하기 클릭
FE -> BE: POST /reservations {seats, phone, password}
BE -> Database: 좌석 예약 가능 여부 검증 및 트랜잭션
Database --> BE: 트랜잭션 결과
BE --> FE: 200 OK + reservation_id
FE -> User: 예약 완료 페이지로 라우팅
@enduml
```

